<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Chat with AI</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --color-main1: #22aeae;
            --color-main2: #e5ddd5;
        }
        body { background-color: #f8f9fa; }
        .k-base-section .card-header {
            background-color: var(--color-main1);
            color: #ffffff;
            font-weight: 600;
            padding-left: 1.5rem;
            padding-right: 1.5rem;
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .k-base-section .card-body {
            background: var(--color-main2);
        }
        .chat-header {
            background-color: var(--color-main1);
            color: rgb(240 240 240);
            padding-left: 1.5rem;
            padding-right: 1.5rem;
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            box-shadow: 0 0 #0000, 0 0 #0000, 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .profile-avatar {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 9999px;
            background-color: #1ba163;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }
        .profile-name {
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #ffffff;
        }
        .chat-container {
            max-width: 500px;
            margin: 30px auto;
            background: #fff;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 80vh;
        }
        .chat-body {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: var(--color-main2);
        }
        .bubble {
            padding: 10px 14px;
            border-radius: 18px;
            margin-bottom: 10px;
            max-width: 75%;
            clear: both;
            white-space: pre-wrap;
        }
        .bubble.me {
            background: #dcf8c6;
            margin-left: auto;
        }
        .bubble.other {
            background: #fff;
            border: 1px solid #ddd;
            margin-right: auto;
        }
        .chat-footer {
            padding: 10px;
            background: var(--color-main1);
        }
        .chat-footer input {
            border-radius: 20px;
        }
    </style>
</head>
<body>

<div class="row pt-4 mx-2">
    <div class="col-md-6">
        <div class="card border-0 shadow chat-container k-base-section">
            <div class="card-header border-0">Knowledge Base üìö</div>
            <div class="card-body d-flex flex-column gap-1">
                <div class="input-group gap-2 mb-2">
                    <select class="form-select" id="api-key" aria-label="Select Group"></select>
                    <select class="form-select" id="api-model" aria-label="Select Model"></select>
                </div>
                <small><b>Information</b></small>
                <div class="alert alert-info border-0 my-0 py-1 alert-dismissible fade show" role="alert">
                    Please fill in any information, AI will search based on this information given first üòä
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                <textarea class="form-control flex-grow-1" id="k-base" placeholder="Type your information here..."
                    style="resize: none;"></textarea>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="chat-container shadow">
            <!-- Chat header -->
            <div class="chat-header">
                <div class="profile-avatar">AI</div>
                <div class="profile-name">Chat with AI ü§ñ</div>
            </div>
            <!-- Chat body -->
            <div class="chat-body" id="chatBody">
                <div class="bubble other">Hello! üëã I'm Chat-AI. Ask me anything.</div>
            </div>

            <!-- Chat footer -->
            <div class="chat-footer">
                <div class="input-group">
                    <input type="text" id="chatInput" class="form-control" placeholder="Type a message...">
                    <button class="btn btn-success" id="sendBtn">Send</button>
                </div>
            </div>
        </div>
    </div>
</div>



<!-- jQuery + Bootstrap Bundle -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
$(document).ready(function(){
    let chatHistory = []; // Add user input to history
    const API_MODEL = [
        {name: 'gemini-2.5 Flash', value: 'gemini-2.5-flash', attr: 'selected'},
        {name: 'gemini-2.5 Flash-lite', value: 'gemini-2.5-flash-lite', attr: ''},
        {name: 'gemini-2.0 Flash', value: 'gemini-2.0-flash', attr: ''},
        {name: 'gemini-2.0 Flash-lite', value: 'gemini-2.0-flash-lite', attr: ''},
    ];
    const GROUP_KEY = [
        {name: 'Group 1', value: 'AIzaSyAN0_9voeAv5iAdeEQWJOyqdy8yfrEJR68', attr: 'selected'},
        {name: 'Group 2', value: 'AIzaSyBH4TR-HZLL0Z1DPjjBLSXhiTagORsP8mA', attr: ''},
        {name: 'Group 3', value: 'AIzaSyCdUR2O6OIs5PlwZ7iJaj15wr3DVZFOImw', attr: ''},
        {name: 'Group 4', value: 'AIzaSyCE8A2NU55bPjIiv8I0oMkLvmY4QkEXKkU', attr: ''},
        {name: 'Group 5', value: 'AIzaSyA4Md7_iWJT6b1jQxtaFSLcVSqK50iuyRg', attr: ''},
        {name: 'Group 6', value: 'AIzaSyC4-LVUHYTb7-qaanqJm6QF-6iaaRPsW1A', attr: ''},
    ];

    async function sendToGemini(prompt = '', kBase = '') {
        try {
            let getModel = $('#api-model').val();
            let getKey = $('#api-key').val();
            const whurl = `https://generativelanguage.googleapis.com/v1beta/models/${getModel}:generateContent?key=${getKey}`;

            // knowledge base
            let addPrompt = '';
            if (kBase != '') {
                addPrompt += `Knowledge base: ${kBase}

                Always check on the knowledge base and answered based on it first.
                If no information found, then switch to general knowledge.`;

                chatHistory.push({
                    role: "user",
                    parts: [{ text: addPrompt }]
                });
            }

            chatHistory.push({
                role: "user",
                parts: [{ text: prompt }]
            });

            if (chatHistory.length > 10) {
                chatHistory = chatHistory.slice(-10);
            }

            const response = await fetch(
                whurl,
                {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        contents: chatHistory
                    })
                }
            );
            const data = await response.json();
            let dataReply = data.candidates?.[0]?.content?.parts?.[0]?.text || "(no reply)";
            let dataError = data.error?.message || false;

            chatHistory.push({
                role: "model",
                parts: [{ text: dataReply }]
            });

            // error
            if (dataError != '') {
                alert(dataError);
            }
            return dataReply;
        } catch (e) {
            return "‚ö†Ô∏è Error: " + e.message;
        }
    }

    async function handleSend() {
        let promptText = $("#chatInput").val().trim();
        let kBaseText= $('#k-base').val().trim();

        if(promptText){
            $("#chatBody").append('<div class="bubble me">'+ promptText +'</div>');
            $("#chatInput").val("");
            $("#chatBody").scrollTop($("#chatBody")[0].scrollHeight);

            // Show loading
            $("#chatBody").append('<div class="bubble other" id="loading">...</div>');
            $("#chatBody").scrollTop($("#chatBody")[0].scrollHeight);

            // Get reply
            let reply = await sendToGemini(promptText, kBaseText);

            // Convert markdown to HTML
            let htmlReply = marked.parse(reply);

            // Replace loading with reply
            $("#loading").remove();
            $("#chatBody").append('<div class="bubble other">'+ htmlReply +'</div>');
            $("#chatBody").scrollTop($("#chatBody")[0].scrollHeight);
        }
    }

    // init input
    $.each(GROUP_KEY, function(i, value) {
        $('#api-key').append(`<option value="${value.value}" ${value.attr}>${value.name}</option>`);
    });

    $.each(API_MODEL, function(i, value) {
        $('#api-model').append(`<option value="${value.value}" ${value.attr}>${value.name}</option>`);
    });

    $("#sendBtn").click(handleSend);

    $("#chatInput").keypress(function(e){
        if(e.which === 13){ handleSend(); return false; }
    });

    $('#k-base').val(`Octopuses have three hearts and blue blood!\n\n1. Two hearts pump blood to the gills, while the third pumps it to the rest of the body.\n\n2. Their blood is blue because it uses copper (hemocyanin) instead of iron (hemoglobin) like ours.\n\n3. Fun twist: the heart that pumps blood to the body actually stops beating when the octopus swims!`)
});
</script>

</body>
</html>
